name: Build Artifacts

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  GO_VERSION: '1.24.11'
  NODE_VERSION: '20'

jobs:
  build-backend:
    name: Build Backend Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            binary_name: budgetd-linux-amd64
          - goos: linux
            goarch: arm64
            binary_name: budgetd-linux-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Build binary
        run: |
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} CGO_ENABLED=0 go build \
            -ldflags="-s -w -X main.version=${{ github.sha }} -X main.buildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.commit=${{ github.sha }}" \
            -o ${{ matrix.binary_name }} ./cmd/budgetd
          chmod +x ${{ matrix.binary_name }} || true

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary_name }}
          path: ${{ matrix.binary_name }}
          retention-days: 30

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install frontend dependencies
        working-directory: web
        run: npm ci

      - name: Build frontend
        working-directory: web
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_GRPC_BASE_URL: ${{ vars.NEXT_PUBLIC_GRPC_BASE_URL || 'http://localhost:8081/grpc' }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL || 'http://localhost:3030' }}
          ENVOY_URL: ${{ vars.ENVOY_URL || 'http://localhost:8081' }}

      - name: Prepare frontend archive
        run: |
          mkdir -p dist-frontend
          # Копируем только необходимые файлы для standalone режима
          cp -r web/.next/standalone/* dist-frontend/
          # Создаем директорию .next и копируем необходимые файлы для production
          mkdir -p dist-frontend/.next
          # Копируем static файлы
          cp -r web/.next/static dist-frontend/.next/static
          # Копируем server директорию (нужна для работы Next.js production server)
          if [ -d web/.next/server ]; then
            cp -r web/.next/server dist-frontend/.next/server
          fi
          # Копируем все файлы из .next (манифесты и метаданные)
          cd web/.next
          find . -maxdepth 1 -type f -exec cp {} ../../dist-frontend/.next/ \;
          cd ../..
          # Копируем package.json из standalone если есть, иначе создаем
          if [ ! -f dist-frontend/package.json ]; then
            echo '{"name":"budget-frontend","version":"1.0.0","scripts":{"start":"node server.js"},"engines":{"node":">=20"}}' > dist-frontend/package.json
          fi
          # Копируем public если существует
          if [ -d web/public ]; then
            cp -r web/public dist-frontend/public
          fi

      - name: Create frontend archive
        run: |
          cd dist-frontend
          tar -czf ../frontend-build.tar.gz .
          cd ..

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend-build.tar.gz
          retention-days: 30

  # Убрано создание draft release - используйте обычные релизы через теги
  # Для деплоя создайте тег (например, v1.0.0) и workflow release.yml создаст релиз

