name: CI

on:
  push:
    branches: [ main, master ]
    tags: [ '*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  actions: read
  contents: read
  packages: write

jobs:
  go:
    runs-on: ubuntu-latest
    env:
      GOTOOLCHAIN: local
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: '1.24.13'
          cache: true
      - name: Install gofumpt
        run: go install mvdan.cc/gofumpt@latest
      - name: Tidy
        run: go mod tidy
      - name: Lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.1.0
          args: --timeout=5m
      - name: Test
        run: go test ./... -race -coverprofile=coverage.out -covermode=atomic
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage.out
          path: coverage.out
  web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      - name: Install deps
        working-directory: web
        run: npm ci || npm install
      - name: Lint
        working-directory: web
        run: npm run lint || echo "eslint not configured, skipping"
      - name: Build
        working-directory: web
        run: npm run build
      - name: Test
        working-directory: web
        run: npm run test
      - name: Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: web/.next
      # - name: Check coverage threshold
      #   run: |
      #     total=$(go tool cover -func=coverage.out | awk '/total:/ {print int($3)}')
      #     echo "Total coverage: ${total}%"
      #     if [ "$total" -lt 80 ]; then echo "coverage below 80%" && exit 1; fi

  docker:
    runs-on: ubuntu-latest
    needs: [go, web]
    if: github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        include:
          - image_suffix: budget-app
            dockerfile: deploy/Dockerfile
            context: .
          - image_suffix: budget-web
            dockerfile: web/Dockerfile
            context: ./web
    steps:
      - uses: actions/checkout@v5
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.image_suffix }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=tag
            type=sha
      - uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_GRPC_BASE_URL=https://budget.qantrix.ru/grpc
            NEXT_PUBLIC_APP_URL=https://budget.qantrix.ru
            ENVOY_URL=https://budget.qantrix.ru/grpc

  release:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: [go, web]
    if: github.event_name == 'push' && github.ref_type == 'tag'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: '1.24.13'
          cache: true
      - name: Download dependencies
        run: go mod download
      - name: Build backend binaries
        run: |
          mkdir -p dist
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w -X main.version=${{ github.ref_name }} -X main.buildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.commit=${{ github.sha }}" -o dist/budgetd-linux-amd64 ./cmd/budgetd
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-s -w -X main.version=${{ github.ref_name }} -X main.buildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.commit=${{ github.sha }}" -o dist/budgetd-linux-arm64 ./cmd/budgetd
          chmod +x dist/budgetd-*
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      - name: Install frontend dependencies
        working-directory: web
        run: npm ci || npm install
      - name: Build frontend
        working-directory: web
        env:
          NODE_ENV: production
          NEXT_PUBLIC_GRPC_BASE_URL: https://budget.qantrix.ru/grpc
          NEXT_PUBLIC_APP_URL: https://budget.qantrix.ru
          ENVOY_URL: https://budget.qantrix.ru/grpc
        run: npm run build
      - name: Create frontend archive
        run: |
          mkdir -p dist-frontend
          cp -r web/.next/standalone/* dist-frontend/
          mkdir -p dist-frontend/.next
          cp -r web/.next/static dist-frontend/.next/static
          if [ -d web/.next/server ]; then cp -r web/.next/server dist-frontend/.next/server; fi
          cd web/.next
          find . -maxdepth 1 -type f -exec cp {} ../../dist-frontend/.next/ \;
          cd ../..
          if [ ! -f dist-frontend/package.json ]; then
            echo '{"name":"budget-frontend","version":"1.0.0","scripts":{"start":"node server.js"},"engines":{"node":">=20"}}' > dist-frontend/package.json
          fi
          if [ -d web/public ]; then cp -r web/public dist-frontend/public; fi
          cd dist-frontend && tar -czf ../dist/frontend-build.tar.gz . && cd ..
      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
          draft: false
          prerelease: false

  go-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: '1.24.13'
          cache: true
      - name: Install Go dependencies
        run: |
          go mod download
          go mod verify
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - name: Run Go security audit
        run: govulncheck ./...

  node-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v5
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      - name: Install frontend dependencies
        working-directory: web
        run: npm ci
      - name: Run npm audit
        working-directory: web
        run: npm audit --audit-level=moderate
      - name: Check outdated packages
        working-directory: web
        run: npm outdated || true

  container-security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v5
      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config-results.sarif'
      - name: Upload Trivy config scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-config-results.sarif'

  build-backend-artifacts:
    name: Build Backend Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'master'))
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            binary_name: budgetd-linux-amd64
          - goos: linux
            goarch: arm64
            binary_name: budgetd-linux-arm64
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: '1.24.13'
          cache: true
      - name: Download dependencies
        run: |
          go mod download
          go mod verify
      - name: Build binary
        run: |
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} CGO_ENABLED=0 go build \
            -ldflags="-s -w -X main.version=${{ github.sha }} -X main.buildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.commit=${{ github.sha }}" \
            -o ${{ matrix.binary_name }} ./cmd/budgetd
          chmod +x ${{ matrix.binary_name }} || true
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary_name }}
          path: ${{ matrix.binary_name }}
          retention-days: 30

  build-frontend-artifact:
    name: Build Frontend Artifact
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'master'))
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      - name: Install frontend dependencies
        working-directory: web
        run: npm ci || npm install
      - name: Build frontend
        working-directory: web
        env:
          NODE_ENV: production
          NEXT_PUBLIC_GRPC_BASE_URL: ${{ vars.NEXT_PUBLIC_GRPC_BASE_URL || 'http://localhost:8081/grpc' }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL || 'http://localhost:3030' }}
          ENVOY_URL: ${{ vars.ENVOY_URL || 'http://localhost:8081' }}
        run: npm run build
      - name: Prepare frontend archive
        run: |
          mkdir -p dist-frontend
          cp -r web/.next/standalone/* dist-frontend/
          mkdir -p dist-frontend/.next
          cp -r web/.next/static dist-frontend/.next/static
          if [ -d web/.next/server ]; then
            cp -r web/.next/server dist-frontend/.next/server
          fi
          cd web/.next
          find . -maxdepth 1 -type f -exec cp {} ../../dist-frontend/.next/ \;
          cd ../..
          if [ ! -f dist-frontend/package.json ]; then
            echo '{"name":"budget-frontend","version":"1.0.0","scripts":{"start":"node server.js"},"engines":{"node":">=20"}}' > dist-frontend/package.json
          fi
          if [ -d web/public ]; then
            cp -r web/public dist-frontend/public
          fi
      - name: Create frontend archive
        run: |
          cd dist-frontend
          tar -czf ../frontend-build.tar.gz .
          cd ..
      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend-build.tar.gz
          retention-days: 30
